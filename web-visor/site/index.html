<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Visor Susceptibilidad a Inundaciones</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@latest/ol.css">
  <link rel="stylesheet" href="assets/css/app.css" />
</head>

<body>

  <!-- Panel izquierdo -->
  <div class="sidebar shadow">
    <h6 class="mb-3">Capas</h6>

    <div class="layer-item">
      <label class="layer-row">
        <input class="form-check-input" type="checkbox" id="chk-osm" checked>
        <span class="layer-name">Mapa base</span>
      </label>
    </div>

    <div class="small text-muted mt-2 mb-2">Susceptibilidad</div>

    <div class="layer-item">
      <label class="layer-row">
        <input class="form-check-input" type="checkbox" id="chk-muy-alta">
        <span class="swatch" style="background:#e76f6f;"></span>
        <span class="layer-name">Muy alta</span>
      </label>
      <input class="opacity-range" type="range" min="0" max="100" value="85" id="op-muy-alta">
    </div>

    <div class="layer-item">
      <label class="layer-row">
        <input class="form-check-input" type="checkbox" id="chk-alta">
        <span class="swatch" style="background:#f2b38d;"></span>
        <span class="layer-name">Alta</span>
      </label>
      <input class="opacity-range" type="range" min="0" max="100" value="50" id="op-alta">
    </div>

    <div class="layer-item">
      <label class="layer-row">
        <input class="form-check-input" type="checkbox" id="chk-media">
        <span class="swatch" style="background:#f6e6a6;"></span>
        <span class="layer-name">Media</span>
      </label>
      <input class="opacity-range" type="range" min="0" max="100" value="35" id="op-media">
    </div>

    <div class="layer-item">
      <label class="layer-row">
        <input class="form-check-input" type="checkbox" id="chk-baja">
        <span class="swatch" style="background:#cfe7b2;"></span>
        <span class="layer-name">Baja</span>
      </label>
      <input class="opacity-range" type="range" min="0" max="100" value="35" id="op-baja">
    </div>

    <div class="layer-item">
      <label class="layer-row">
        <input class="form-check-input" type="checkbox" id="chk-muy-baja">
        <span class="swatch" style="background:#b9dfd7;"></span>
        <span class="layer-name">Muy baja</span>
      </label>
      <input class="opacity-range" type="range" min="0" max="100" value="35" id="op-muy-baja">
    </div>
  </div>

  <!-- Mapa -->
  <div id="map"></div>

  <!-- Toolbar inferior centrada -->
  <div class="toolbar-bottom shadow">
    <button class="btn btn-light" id="tool-zoom-in" title="Zoom in"><i class="bi bi-zoom-in"></i></button>
    <button class="btn btn-light" id="tool-zoom-out" title="Zoom out"><i class="bi bi-zoom-out"></i></button>
    <button class="btn btn-light" id="tool-home" title="Vista inicial"><i class="bi bi-house"></i></button>
  </div>

  <!-- Logo -->
  <div class="brand-logo">
    <img src="assets/logo/logo_fto.jpg" alt="FTO América S.A.">
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ol@latest/dist/ol.js"></script>

  <script>
    // ========= CONFIG =========
 
    const MAP_PATH = "/project/Susceptibilidad_a_inundacion.qgz";
    const owsBase = `/ows/?MAP=${encodeURIComponent(MAP_PATH)}`;

    // Nombres EXACTOS de capas WMS (tal cual Capabilities)
    const WMS = {
      muy_alta: "Muy alta",
      alta: "Alta",
      media: "Media",
      baja: "Baja",
      muy_baja: "Muy baja"
    };

    // el estilo real que aparece en tu XML
    const STYLE_NAME = "predeterminado";

    let homeExtent3857 = null;

    // ========= HELPERS =========
    function makeWmsLayer(layerName, opacityDefault) {
      return new ol.layer.Image({
        source: new ol.source.ImageWMS({
          url: owsBase,
          params: {
            SERVICE: "WMS",
            VERSION: "1.3.0",
            REQUEST: "GetMap",
            LAYERS: layerName,
            STYLES: STYLE_NAME,
            FORMAT: "image/png",
            TRANSPARENT: true
          },
          ratio: 1,
          crossOrigin: "anonymous"
        }),
        opacity: opacityDefault,
        visible: false // ✅ no consume hasta prender
      });
    }

    // ========= CAPAS =========
    const osm = new ol.layer.Tile({ source: new ol.source.OSM(), visible: true });

    const lyrMuyAlta = makeWmsLayer(WMS.muy_alta, 0.85);
    const lyrAlta    = makeWmsLayer(WMS.alta,    0.50);
    const lyrMedia   = makeWmsLayer(WMS.media,   0.35);
    const lyrBaja    = makeWmsLayer(WMS.baja,    0.35);
    const lyrMuyBaja = makeWmsLayer(WMS.muy_baja,0.35);

    // ========= MAPA =========
    const view = new ol.View({
      projection: "EPSG:3857",
      center: ol.proj.fromLonLat([-76.75, 0.12]), // fallback
      zoom: 10
    });

    const map = new ol.Map({
      target: "map",
      layers: [osm, lyrMuyBaja, lyrBaja, lyrMedia, lyrAlta, lyrMuyAlta],
      view
    });

    // ========= EXTENT REAL DESDE CAPABILITIES (tu capa, no el OSM) =========
    function loadHomeExtentFromCapabilities(layerNameForExtent = WMS.muy_alta) {
      const capUrl = `${owsBase}&SERVICE=WMS&REQUEST=GetCapabilities`;

      return fetch(capUrl)
        .then(r => r.text())
        .then(text => {
          const xml = new DOMParser().parseFromString(text, "text/xml");
          const layers = Array.from(xml.getElementsByTagName("Layer"));

          const target = layers.find(l => {
            const n = l.getElementsByTagName("Name")[0];
            return n && n.textContent === layerNameForExtent;
          });

          if (!target) throw new Error("Capa no encontrada en capabilities");

          const geo = target.getElementsByTagName("EX_GeographicBoundingBox")[0];
          if (!geo) throw new Error("Sin EX_GeographicBoundingBox");

          const west  = parseFloat(geo.getElementsByTagName("westBoundLongitude")[0].textContent);
          const east  = parseFloat(geo.getElementsByTagName("eastBoundLongitude")[0].textContent);
          const south = parseFloat(geo.getElementsByTagName("southBoundLatitude")[0].textContent);
          const north = parseFloat(geo.getElementsByTagName("northBoundLatitude")[0].textContent);

          homeExtent3857 = ol.proj.transformExtent(
            [west, south, east, north],
            "EPSG:4326",
            "EPSG:3857"
          );

          view.fit(homeExtent3857, { padding: [80, 80, 80, 80] });
        })
        .catch(() => {
          homeExtent3857 = null;
          view.setCenter(ol.proj.fromLonLat([-76.75, 0.12]));
          view.setZoom(10);
        });
    }

    // fit inicial
    loadHomeExtentFromCapabilities(WMS.muy_alta);

    // ========= UI BINDINGS =========
    function bindToggle(id, layer) {
      const el = document.getElementById(id);
      el.addEventListener("change", () => {
        layer.setVisible(el.checked);
      });
    }

    function bindOpacity(id, layer) {
      const el = document.getElementById(id);
      el.addEventListener("input", () => layer.setOpacity(parseInt(el.value, 10) / 100));
    }

    bindToggle("chk-osm", osm);
    bindToggle("chk-muy-alta", lyrMuyAlta);
    bindToggle("chk-alta", lyrAlta);
    bindToggle("chk-media", lyrMedia);
    bindToggle("chk-baja", lyrBaja);
    bindToggle("chk-muy-baja", lyrMuyBaja);

    bindOpacity("op-muy-alta", lyrMuyAlta);
    bindOpacity("op-alta", lyrAlta);
    bindOpacity("op-media", lyrMedia);
    bindOpacity("op-baja", lyrBaja);
    bindOpacity("op-muy-baja", lyrMuyBaja);

    document.getElementById("tool-zoom-in").addEventListener("click", () => {
      view.animate({ zoom: (view.getZoom() ?? 10) + 1, duration: 150 });
    });

    document.getElementById("tool-zoom-out").addEventListener("click", () => {
      view.animate({ zoom: (view.getZoom() ?? 10) - 1, duration: 150 });
    });

    document.getElementById("tool-home").addEventListener("click", () => {
      if (homeExtent3857) {
        view.fit(homeExtent3857, { padding: [80, 80, 80, 80], duration: 200 });
      } else {
        loadHomeExtentFromCapabilities(WMS.muy_alta);
      }
    });
  </script>
</body>
</html>
