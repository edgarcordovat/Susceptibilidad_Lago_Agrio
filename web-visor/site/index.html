<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Visor Susceptibilidad a Inundaciones</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@latest/ol.css">
  <link rel="stylesheet" href="assets/css/app.css" />
</head>

<body>

  <!-- Panel izquierdo -->
  <div class="sidebar shadow">
    <h6 class="mb-3">Capas</h6>

    <div class="layer-item">
      <label class="layer-row">
        <input class="form-check-input" type="checkbox" id="chk-osm" checked>
        <span class="layer-name">Mapa base</span>
      </label>
    </div>

    <div class="small text-muted mt-2 mb-2">Susceptibilidad</div>

    <div class="layer-item">
      <label class="layer-row">
        <input class="form-check-input" type="checkbox" id="chk-muy-alta">
        <span class="swatch" style="background:#e76f6f;"></span>
        <span class="layer-name">Muy alta</span>
      </label>
      <input class="opacity-range" type="range" min="0" max="100" value="85" id="op-muy-alta">
    </div>

    <div class="layer-item">
      <label class="layer-row">
        <input class="form-check-input" type="checkbox" id="chk-alta">
        <span class="swatch" style="background:#f2b38d;"></span>
        <span class="layer-name">Alta</span>
      </label>
      <input class="opacity-range" type="range" min="0" max="100" value="85" id="op-alta">
    </div>

    <div class="layer-item">
      <label class="layer-row">
        <input class="form-check-input" type="checkbox" id="chk-media">
        <span class="swatch" style="background:#f6e6a6;"></span>
        <span class="layer-name">Media</span>
      </label>
      <input class="opacity-range" type="range" min="0" max="100" value="85" id="op-media">
    </div>

    <div class="layer-item">
      <label class="layer-row">
        <input class="form-check-input" type="checkbox" id="chk-baja">
        <span class="swatch" style="background:#cfe7b2;"></span>
        <span class="layer-name">Baja</span>
      </label>
      <input class="opacity-range" type="range" min="0" max="100" value="85" id="op-baja">
    </div>

    <div class="layer-item">
      <label class="layer-row">
        <input class="form-check-input" type="checkbox" id="chk-muy-baja">
        <span class="swatch" style="background:#b9dfd7;"></span>
        <span class="layer-name">Muy baja</span>
      </label>
      <input class="opacity-range" type="range" min="0" max="100" value="85" id="op-muy-baja">
    </div>
  </div>

  <!-- Mapa -->
  <div id="map"></div>

  <!-- Toolbar inferior centrada -->
  <div class="toolbar-bottom shadow">
    <button class="btn btn-light" id="tool-zoom-in" title="Zoom in"><i class="bi bi-zoom-in"></i></button>
    <button class="btn btn-light" id="tool-zoom-out" title="Zoom out"><i class="bi bi-zoom-out"></i></button>
    <button class="btn btn-light" id="tool-home" title="Vista inicial"><i class="bi bi-house"></i></button>
  </div>

  <!-- Logo -->
  <div class="brand-logo">
    <img src="assets/logo/logo_fto.jpg" alt="FTO América S.A.">
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ol@latest/dist/ol.js"></script>

  <script>
    // ========= CONFIG =========
    // Cuando tengas QGIS Server en Railway, reemplaza esto:
    const QGIS_BASE_URL = "http://TU-QGIS-SERVER"; // Ej: https://qgis-server-production.up.railway.app

    // En Railway (Linux) NO es .exe. Será:
    // /cgi-bin/qgis_mapserv.fcgi
    const qgisUrl =
      QGIS_BASE_URL +
      "/cgi-bin/qgis_mapserv.fcgi" +
      "?MAP=/data/Susceptibilidad%20a%20inundacion.qgz";

    // Nombres EXACTOS de capas WMS (ajusta si cambia en QGIS)
    const WMS = {
      muy_alta: "Muy alta",
      alta: "Alta",
      media: "Media",
      baja: "Baja",
      muy_baja: "Muy Baja"
    };

    // ========= HELPERS =========
    function makeWmsLayer(layerName) {
      return new ol.layer.Image({
        source: new ol.source.ImageWMS({
          url: qgisUrl,
          params: {
            SERVICE: "WMS",
            VERSION: "1.3.0",
            REQUEST: "GetMap",
            LAYERS: layerName,
            STYLES: "",
            FORMAT: "image/png",
            TRANSPARENT: true
          },
          ratio: 1
        }),
        opacity: 0.85,
        visible: false // ✅ NO consume hasta prender
      });
    }

    // ========= CAPAS =========
    const osm = new ol.layer.Tile({ source: new ol.source.OSM(), visible: true });

    const lyrMuyAlta = makeWmsLayer(WMS.muy_alta);
    const lyrAlta    = makeWmsLayer(WMS.alta);
    const lyrMedia   = makeWmsLayer(WMS.media);
    const lyrBaja    = makeWmsLayer(WMS.baja);
    const lyrMuyBaja = makeWmsLayer(WMS.muy_baja);

    // ========= MAPA =========
    const view = new ol.View({
      projection: "EPSG:3857",
      center: ol.proj.fromLonLat([-78.5, -1.0]),
      zoom: 7
    });

    const map = new ol.Map({
      target: "map",
      layers: [osm, lyrMuyBaja, lyrBaja, lyrMedia, lyrAlta, lyrMuyAlta],
      view
    });

    // ========= UI BINDINGS =========
    function bindToggle(id, layer) {
      const el = document.getElementById(id);
      el.addEventListener("change", () => layer.setVisible(el.checked));
    }

    function bindOpacity(id, layer) {
      const el = document.getElementById(id);
      el.addEventListener("input", () => layer.setOpacity(parseInt(el.value, 10) / 100));
    }

    bindToggle("chk-osm", osm);
    bindToggle("chk-muy-alta", lyrMuyAlta);
    bindToggle("chk-alta", lyrAlta);
    bindToggle("chk-media", lyrMedia);
    bindToggle("chk-baja", lyrBaja);
    bindToggle("chk-muy-baja", lyrMuyBaja);

    bindOpacity("op-muy-alta", lyrMuyAlta);
    bindOpacity("op-alta", lyrAlta);
    bindOpacity("op-media", lyrMedia);
    bindOpacity("op-baja", lyrBaja);
    bindOpacity("op-muy-baja", lyrMuyBaja);

    document.getElementById("tool-zoom-in").addEventListener("click", () => {
      view.animate({ zoom: (view.getZoom() ?? 7) + 1, duration: 150 });
    });

    document.getElementById("tool-zoom-out").addEventListener("click", () => {
      view.animate({ zoom: (view.getZoom() ?? 7) - 1, duration: 150 });
    });

    // Home: lo dejamos sin capabilities hasta que tengas el QGIS listo.
    // Luego lo activamos para hacer fit a extent real.
    document.getElementById("tool-home").addEventListener("click", () => {
      view.animate({ center: ol.proj.fromLonLat([-78.5, -1.0]), zoom: 7, duration: 200 });
    });
  </script>
</body>
</html>
